rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getRole() {
      return request.auth.token.role;
    }

    function getTenant() {
      return request.auth.token.tenantId;
    }

    function isRole(role) {
      return isSignedIn() && getRole() == role;
    }

    function isTenantMember(tenantId) {
      return isSignedIn() && getTenant() == tenantId;
    }

    // --- Role-based access check functions ---
    function isSecretAdmin() {
      return isRole('L2 Admin');
    }

    function isCompanySuperAdmin() {
      return isRole('company_super_admin_read_write');
    }

    function isCompanySupport() {
        return isRole('company_tech_support_read_only') || isRole('company_customer_support_read_only');
    }

    // Global role: IsGlobal flag set in custom claims by inviteUser
    function isGlobalRole() {
        return isSignedIn() && request.auth.token.isGlobal == true;
    }

    function isTenantSuperUser(tenantId) {
        return isTenantMember(tenantId) && isRole('tenant_admin_super_user');
    }

    function isTenantAdminWrite(tenantId) {
        return isTenantMember(tenantId) && isRole('tenant_admin_read_write');
    }

    function isTenantAdminRead(tenantId) {
        return isTenantMember(tenantId) && isRole('tenant_admin_read_only');
    }

    function isTenantUser(tenantId) {
        return isTenantMember(tenantId);
    }


    // --- Rules ---

    // Secret admin has global read/write access.
    match /{path=**} {
      allow read, write: if isSecretAdmin();
    }

    // Global roles (IsGlobal) have read/write access to everything
    match /{path=**} {
      allow read, write: if isGlobalRole();
    }

    // Global user-role mappings
    match /global_users/{docId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == docId
         && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'last_login', 'last_updated']);
      allow write: if isSecretAdmin() || isGlobalRole() || isCompanySuperAdmin() || isTenantSuperUser(request.auth.token.tenantId)
         || isTenantAdminWrite(request.auth.token.tenantId);
    }

    // Global role definitions (role_types)
    match /role_types/{roleId} {
      allow read: if request.auth != null;
      allow write: if isSecretAdmin() || isGlobalRole() || isCompanySuperAdmin() || isTenantSuperUser(request.auth.token.tenantId);
    }

    // Global dimensions mapping
    match /dimensions/{dimensionId} {
      allow read: if request.auth != null;
      allow write: if isGlobalRole() || isCompanySuperAdmin() || isTenantSuperUser(request.auth.token.tenantId);
    }

    // Rules for data within a tenant.
    match /tenants/{tenantId}/{document=**} {
      allow read, write: if isCompanySuperAdmin() || isSecretAdmin() || isGlobalRole();
      allow read: if isCompanySupport() || isTenantAdminRead(tenantId) || isTenantMember(tenantId);
      allow write: if isTenantSuperUser(tenantId) || isTenantAdminWrite(tenantId);
    }

    // Rules for specific collections for a tenant_user.
    match /tenants/{tenantId}/users/{userId} {
        allow read: if isTenantMember(tenantId) && (request.auth.uid == userId || resource.data.auth_uid == request.auth.uid);
        allow update: if isTenantMember(tenantId) && resource.data.auth_uid == request.auth.uid
           && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['user_name', 'phone', 'status', 'last_login', 'last_updated', 'updated_at']);
    }

    match /tenants/{tenantId}/projects/{projectId} {
        allow read: if isTenantMember(tenantId);
    }

    match /tenants/{tenantId}/contracts/{contractId} {
        allow read: if isTenantMember(tenantId);
    }

    match /tenants/{tenantId}/reports/{reportId} {
        allow read: if isTenantMember(tenantId);
    }
  }
}
